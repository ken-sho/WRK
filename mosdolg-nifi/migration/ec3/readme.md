## Последовательность миграции сущностей

В круглых скобках указаны сущности, таблицы которых ссылаются на таблицы данной сущности.

1. Организации - [organization] (площадки, соглашения)
2. Сотрудники - [coworker] (соглашения, группы)
3. Площадки – [place] (группы)
4. Личное дело - Участники - [participant] (профили активности, группы (записи в группу))
5. Профили активности - [activity_profile] (группы (записи в группу), соглашения)
6. Соглашения - [contract] (группы)
7. Группы и графики занятий - [group]
8. Пользователи и роли

## Полный процесс миграции

### Пререквизиты
- В NiFi перенесены все актуальные скрипты и схемы из репозитория.

Для переноса скриптов в группе процессоров `ЕСЗ. Миграция` необходимо заполнить атрибуты в процессоре `SQL-Скрипты`

Для переноса схем нужно перенести схемы в `AvroSchemaRegistry` в разделе `ControllerServices` группы процессоров `ЕСЗ. Миграция`
 

### Процесс

1. Выполнение скрипта `clean.sql` (сейчас для этого используется любой psql-клиент)
2. Запуск процессора `Все сущности` в NiFi
3. NiFi наполняет `sdb`
4. Последовательное выполнение скриптов `transformation.sql` всех сущностей в соответствии
с последовательностью выше – наполнение `idb`
5. Последовательное выполнение скриптов `push.sql` всех сущностей в соответствии с
последовательностью выше – очистка `md`, `reference` и наполнение `md`, `reference`, `ar.adress_registry`

### Особенности процесса

Общие особенности

- При изменении любого скрипта `extract.sql` требуется полная миграция всех сущностей заново

Шаг 1 – нужен для
- очистки всех схем миграции для создания в них записей с нуля и для
создания sequence для сущности "Пользователи и роли" в связи с тем, что в NiFi скрипты
содержащие создание сиквенсов не прогоняются

Шаги 2 и 3 – нужны для выполнения в NiFi работы по перегону из `MariaDB` в `PostgreSQL` 

Шаг 4 – на этом шаге в самом начале могут встречаться `truncate table idb.*` для ситуации, когда
эта фаза прогоняется больше одного раза, чтобы не начинать всю миграцию заново

*!Важно!* не добавлять в `transformation.sql` строки `truncate table idb.*_map` для перекодировочных таблиц, иначе слетят все айдишники
и миграцию придется осуществлять заново

Шаг 5 - на этом шаге в самом начале выполняется *каскадное* удаление записей в таблицах схемы `md`.
Это влечет за собой очистку всех данных по всем сущностям. С этим нужно быть аккуратнее.

Шаг 5 выполняется *Всегда* для *Всех* сущностей, с которых начинается, потому что каскадное удаление по первой сущности влечет
за собой каскадную очистку данных по остальным

Например, если выполнить шаг 5 для сущности "Группы и графики занятий", то можно не делать всю миграцию заново, поскольку
не существует зависимых от них сущностей

Но если выполнять шаг 5 с сущности "Сотрудники" то необходимо последовательно выполнить шаг 5 для всех сущностей ниже по списку

